<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Admin</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="auth.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 5px solid var(--accent-color);
        }
        .stat-info h3 { margin: 0; font-size: 1.8em; color: #333; }
        .stat-info p { margin: 5px 0 0; color: #777; }
        .stat-icon { font-size: 2.5em; color: #ddd; }

        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        @media (max-width: 1000px) {
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-paw"></i> ADMIN</h2>
        </div>
        <div class="sidebar-menu">
            <a href="index.html" class="active"><i class="fas fa-tachometer-alt"></i> Tổng quan</a>
            <a href="users.html"><i class="fas fa-users"></i> Người dùng</a>
            <a href="products.html"><i class="fas fa-box-open"></i> Sản phẩm</a>
            <a href="categories.html"><i class="fas fa-tags"></i> Danh mục</a>
            <a href="orders.html"><i class="fas fa-shopping-cart"></i> Đơn hàng</a>
            <a href="#" id="logout-btn" onclick="logoutAndGoHome()" style="margin-top: 50px; border-top: 1px solid #34495e;">
                <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </a>
        </div>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h1>Tổng Quan Hệ Thống</h1>
            <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="window.location.href='profile.html'">
                <div style="text-align: right;">
                    <strong id="admin-name">Admin</strong><br>
                    <small>Quản trị viên</small>
                </div>
                <div style="width: 40px; height: 40px; background: #bdc3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card" style="border-left-color: #3498db;">
                <div class="stat-info">
                    <h3 id="stat-orders">...</h3>
                    <p>Đơn hàng mới</p>
                </div>
                <div class="stat-icon"><i class="fas fa-shopping-bag"></i></div>
            </div>
            
            <div class="stat-card" style="border-left-color: #2ecc71;">
                <div class="stat-info">
                    <h3 id="stat-revenue">...</h3>
                    <p>Doanh thu (VNĐ)</p>
                </div>
                <div class="stat-icon"><i class="fas fa-money-bill-wave"></i></div>
            </div>

            <div class="stat-card" style="border-left-color: #f1c40f;">
                <div class="stat-info">
                    <h3 id="stat-customers">...</h3>
                    <p>Khách hàng</p>
                </div>
                <div class="stat-icon"><i class="fas fa-users"></i></div>
            </div>

            <div class="stat-card" style="border-left-color: #e74c3c;">
                <div class="stat-info">
                    <h3>Ổn định</h3>
                    <p>Hệ thống</p>
                </div>
                <div class="stat-icon"><i class="fas fa-server"></i></div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h3><i class="fas fa-chart-line"></i> Biểu đồ Doanh thu (Năm nay)</h3>
                <canvas id="revenueChart"></canvas>
            </div>

            <div class="chart-card">
                <h3><i class="fas fa-chart-pie"></i> Trạng thái Đơn hàng</h3>
                <canvas id="statusChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <script>
        function logoutAndGoHome() {
            localStorage.clear();
            window.location.href = '../regis_log/login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('accessToken');
            const username = localStorage.getItem('currentUsername');
            document.getElementById('admin-name').textContent = username || 'Admin';
            const API_STATS = 'http://localhost:1010/admin/stats';

            async function loadDashboardData() {
                try {
                    const resRev = await fetch(`${API_STATS}/revenue`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (resRev.status === 401) return; 
                    
                    const revenueData = await resRev.json(); 
                    const resStatus = await fetch(`${API_STATS}/status`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const statusMap = await resStatus.json();

                    const totalRev = revenueData.reduce((a, b) => a + b, 0);
                    document.getElementById('stat-revenue').textContent = totalRev.toLocaleString('vi-VN');
                    const totalOrders = Object.values(statusMap).reduce((a, b) => a + b, 0);
                    document.getElementById('stat-orders').textContent = totalOrders;
                    document.getElementById('stat-customers').textContent = "N/A";

                    drawRevenueChart(revenueData);
                    drawStatusChart(statusMap);

                } catch (error) {
                    console.error("Lỗi tải thống kê:", error);
                }
            }

            function drawRevenueChart(data) {
                const ctx = document.getElementById('revenueChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'],
                        datasets: [{
                            label: 'Doanh thu (VNĐ)',
                            data: data,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: { responsive: true }
                });
            }

            function drawStatusChart(dataMap) {
                const counts = [
                    dataMap['0'] || 0, // Chờ
                    dataMap['1'] || 0, // Đã TT
                    dataMap['2'] || 0, // Giao
                    dataMap['3'] || 0, // Xong
                    dataMap['4'] || 0  // Hủy
                ];

                const ctx = document.getElementById('statusChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Chờ xử lý', 'Đã thanh toán', 'Đang giao', 'Hoàn thành', 'Đã hủy'],
                        datasets: [{
                            data: counts,
                            backgroundColor: ['#f1c40f', '#3498db', '#9b59b6', '#2ecc71', '#e74c3c'],
                            hoverOffset: 4
                        }]
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }

            loadDashboardData();
        });
    </script>
</body>
</html>